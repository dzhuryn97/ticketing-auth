name: Deploy to dev env
on:
    push:
        branches:
            - dev
jobs:
#    test:
#         uses: ./.github/workflows/test.yml
    build:
#        needs: test
        uses: ./.github/workflows/build.yml
        with:
            image-tag: dev
            image-php-target: dev
        secrets:
            dockerUser: ${{ secrets.DOCKER_USER }}
            dockerPassword: ${{ secrets.DOCKER_PASSWORD }}
    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            -   name: ssh key passphrase
                uses: appleboy/ssh-action@v1.0.3
                with:
                    host: ${{ secrets.SERVER_HOST }}
                    username: ${{ secrets.SERVER_USERNAME }}
                    key: ${{ secrets.SERVER_KEY }}
                    debug: true
                    script: |
                        cd /var/www/ticketing
                        docker image pull dzhuryn/ticketing-auth-webserver:dev
                        docker image pull dzhuryn/ticketing-auth-php:dev
                        docker image pull dzhuryn/ticketing-auth-jobber:dev
                        docker compose up -d --force-recreate

                        docker compose exec auth_php bin/console doctrine:migrations:migrate --no-interaction
                        docker compose exec auth_php bin/console doctrine:fixtures:load --no-interaction
